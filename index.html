<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema Integrado de Regula√ß√£o UBS</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="style-central.css">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .acoes {
      display: flex;
      gap: 0.5rem;
    }
    
    .btn-acao {
      padding: 0.3rem 0.8rem;
      font-size: 0.85rem;
      border-radius: var(--borda-arredondada);
      cursor: pointer;
      border: 1px solid var(--cor-borda);
      background-color: #fff;
    }
    
    .btn-acao.visualizar {
      color: var(--cor-destaque);
      border-color: var(--cor-destaque);
    }
    
    .btn-acao.editar {
      color: var(--cor-aviso);
      border-color: var(--cor-aviso);
    }
    
    .btn-acao.cancelar {
      color: var(--cor-erro);
      border-color: var(--cor-erro);
    }
    
    .nova-solicitacao {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 1rem;
    }
    
    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 99px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    
    .status-badge.rascunho {
      background-color: #f1f1f1;
      color: #666;
    }
    
    .status-badge.enviado {
      background-color: #e8f4fd;
      color: var(--cor-destaque);
    }
    
    .status-badge.aprovado {
      background-color: #e6f7ef;
      color: var(--cor-sucesso);
    }
    
    .status-badge.rejeitado {
      background-color: #fdeeee;
      color: var(--cor-erro);
    }
    
    .vazio-mensagem {
      text-align: center;
      padding: 2rem;
      color: #777;
    }
    
    .dados-debug {
      margin-top: 2rem;
      padding: 1rem;
      background-color: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: var(--borda-arredondada);
    }
    
    .dados-debug h3 {
      margin-top: 0;
      color: #555;
    }
    
    .dados-debug pre {
      background-color: #eee;
      padding: 1rem;
      border-radius: 4px;
      overflow: auto;
      font-size: 0.9rem;
    }

    #app-container {
      min-height: 80vh;
    }
  </style>
</head>
<body>
  <!-- Containers para componentes din√¢micos -->
  <div id="header-container"></div>
  
  <main id="app-container">
    <div class="carregando-container">
      <div class="carregando"></div>
    </div>
  </main>
  
  <div id="footer-container"></div>
  
  <!-- Navega√ß√£o lateral integrada -->
  <div id="nav-container" class="lateral-nav"></div>
  
  <!-- Scripts -->
  <script type="module">
    import './scripts/main.js';
    import apiService from './scripts/api.js';
    import authService from './scripts/auth.js';
    import dependenciasManager from './scripts/dependencias.js';
    import integracaoSistema from './scripts/integracao.js';
    import { carregarComponente } from './scripts/utils.js';
    
    // Fun√ß√£o para carregar componentes espec√≠ficos desta p√°gina
    window.carregarComponentesPagina = async function() {
      try {
        // Carregar navega√ß√£o lateral
        await carregarComponente('#nav-container', 'includes/navigation.html', () => {
          // Ap√≥s carregamento, ajustar interface para o perfil
          integracaoSistema.ajustarInterfaceParaPerfil();
        });
        
        // Carregar dados compartilhados
        await integracaoSistema.carregarDadosCompartilhados();
        
        // Renderizar dashboard integrado
        renderizarDashboardIntegrado();
      } catch (error) {
        console.error('Erro ao carregar componentes da p√°gina:', error);
      }
    };
    
    // Renderizar dashboard integrado com elementos de ambos os sistemas
    async function renderizarDashboardIntegrado() {
      const appContainer = document.getElementById('app-container');
      
      // Obter perfil do usu√°rio para customizar dashboard
      const usuario = authService.getUsuarioAtual();
      const perfil = usuario?.perfil || 'visitante';
      
      // Layout do dashboard baseado no perfil
      const dashboardHTML = `
        <section class="dashboard-integrado">
          <h2>Dashboard Central - ${usuario?.nome || 'Usu√°rio'}</h2>
          <p class="ultima-atualizacao">√öltima atualiza√ß√£o: <span id="timestamp">${new Date().toLocaleString()}</span></p>
          
          <!-- M√©tricas principais - Comum para todos perfis -->
          <div class="dashboard-cards">
            <div class="card-metrica total" id="card-total">
              <h3>Total de Solicita√ß√µes</h3>
              <p class="valor-metrica" id="total-solicitacoes">--</p>
            </div>
            
            <div class="card-metrica pendentes">
              <h3>Solicita√ß√µes Pendentes</h3>
              <p class="valor-metrica" id="contador-enviado">--</p>
            </div>
            
            <div class="card-metrica ${perfil === 'ubs' ? 'enviadas' : 'urgentes'}">
              <h3>${perfil === 'ubs' ? 'Minhas Solicita√ß√µes' : 'Urg√™ncias Pendentes'}</h3>
              <p class="valor-metrica" id="${perfil === 'ubs' ? 'contador-rascunho' : 'urgencias-pendentes'}">--</p>
            </div>
            
            <div class="card-metrica tempo">
              <h3>Cotas Dispon√≠veis</h3>
              <p class="valor-metrica" id="cotas-disponiveis">--</p>
            </div>
          </div>
          
          <!-- Gr√°ficos do Dashboard -->
          <div class="dashboard-graficos">
            <div class="grafico-container">
              <h3>Status das Solicita√ß√µes</h3>
              <div class="grafico">
                <canvas id="statusChart"></canvas>
              </div>
            </div>
            <div class="grafico-container">
              <h3>Solicita√ß√µes por Tipo</h3>
              <div class="grafico">
                <canvas id="tiposChart"></canvas>
              </div>
            </div>
          </div>
          
          <!-- Tabelas informativas - Espec√≠ficas por perfil -->
          <div class="dashboard-tabelas">
            <div class="tabela-container">
              <h3>Cotas Cr√≠ticas</h3>
              <table class="tabela-cotas">
                <thead>
                  <tr>
                    <th>Procedimento</th>
                    <th>Dispon√≠vel</th>
                    <th>Total</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Preenchido dinamicamente -->
                </tbody>
              </table>
            </div>
            
            <div class="tabela-container">
              <h3>${perfil === 'ubs' ? 'Minhas Solicita√ß√µes Recentes' : 'Atividades Recentes'}</h3>
              <div class="lista-atividades">
                <!-- Preenchido dinamicamente -->
              </div>
            </div>
          </div>
          
          <!-- Se√ß√£o espec√≠fica para Central de Regula√ß√£o -->
          <div class="central-secao" style="display: ${['regulador', 'admin'].includes(perfil) ? 'block' : 'none'}">
            <h3>Alertas do Sistema de Regula√ß√£o</h3>
            <div class="alertas-container">
              <!-- Preenchido dinamicamente -->
            </div>
          </div>
          
          <!-- Se√ß√£o espec√≠fica para UBS -->
          <div class="ubs-secao" style="display: ${['ubs', 'admin'].includes(perfil) ? 'block' : 'none'}">
            <h3>A√ß√µes R√°pidas</h3>
            <div class="acoes-rapidas">
              <a href="etapa1.html" class="btn-acao-rapida nova-solicitacao">
                <span class="icone">+</span>
                <span class="texto">Nova Solicita√ß√£o</span>
              </a>
              <a href="#" class="btn-acao-rapida consultar">
                <span class="icone">üîç</span>
                <span class="texto">Consultar Solicita√ß√µes</span>
              </a>
              <a href="#" class="btn-acao-rapida rascunhos">
                <span class="icone">üìÑ</span>
                <span class="texto">Meus Rascunhos</span>
              </a>
            </div>
          </div>
        </section>
      `;
      
      // Renderizar HTML
      appContainer.innerHTML = dashboardHTML;
      
      // Atualizar dados na interface
      integracaoSistema.atualizarIndicadores();
      
      // Inicializar gr√°ficos
      inicializarGraficos();
    }
    
    // Inicializar gr√°ficos do dashboard
    function inicializarGraficos() {
      // Gr√°fico de Status das Solicita√ß√µes
      const ctxStatus = document.getElementById('statusChart').getContext('2d');
      if (ctxStatus) {
        const statusChart = new Chart(ctxStatus, {
          type: 'pie',
          data: {
            labels: ['Pendentes', 'Aprovadas', 'Negadas', 'Devolvidas'],
            datasets: [{
              data: [128, 187, 42, 30],
              backgroundColor: [
                '#ffc107', // amarelo
                '#28a745', // verde 
                '#dc3545', // vermelho
                '#6c757d'  // cinza
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'right',
              }
            }
          }
        });
      }
      
      // Gr√°fico de Solicita√ß√µes por Tipo
      const ctxTipos = document.getElementById('tiposChart').getContext('2d');
      if (ctxTipos) {
        const tiposChart = new Chart(ctxTipos, {
          type: 'bar',
          data: {
            labels: ['Exames', 'Consultas', 'Procedimentos', 'Medicamentos', 'Interna√ß√µes'],
            datasets: [{
              label: 'Quantidade',
              data: [145, 102, 58, 47, 35],
              backgroundColor: 'rgba(0, 107, 166, 0.7)',
              borderColor: 'rgba(0, 107, 166, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      }
    }
  </script>
</body>
</html> 